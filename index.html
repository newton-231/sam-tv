<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SAMTV PRO - FIXED ID</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  :root { --bg: #000; --primary: #0af; --card: #1c1c1e; }
  *{box-sizing:border-box; font-family:-apple-system, sans-serif}
  body{margin:0; background:var(--bg); color:#fff; height:100vh; overflow:hidden; display:flex; flex-direction:column}
  #loginScreen{margin:auto; width:90%; max-width:320px; text-align:center}
  input,button{width:100%; padding:15px; margin:10px 0; border:none; border-radius:10px; font-size:16px}
  input{background:#2c2c2e; color:#fff; text-align:center}
  button{background:var(--primary); color:#000; font-weight:bold; cursor:pointer}
  #appScreen{display:none; flex:1; flex-direction:column; overflow:hidden}
  header{background:#1c1c1e; padding:15px; display:flex; justify-content:space-between; align-items:center}
  video{width:100%; aspect-ratio:16/9; background:#000}
  .scroll-area{flex:1; overflow-y:auto; padding:10px}
  .row-title{font-size:18px; margin:15px 5px; color:var(--primary); border-right:4px solid var(--primary); padding-right:10px}
  .row{display:flex; overflow-x:auto; gap:12px; padding-bottom:10px; min-height:100px}
  .card{flex:0 0 120px; background:var(--card); border-radius:10px; text-align:center; cursor:pointer}
  .card img{width:100%; height:160px; object-fit:cover; border-radius:10px 10px 0 0; background:#333}
  .card p{font-size:11px; margin:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
</style>
</head>
<body>

<div id="loginScreen">
  <h1 style="color:var(--primary)">SAMTV PRO</h1>
  <input id="code" placeholder="أدخل كود التفعيل">
  <button onclick="activate()">تفعيل ودخول</button>
  <p id="status" style="font-size:12px; color:#ff3b30"></p>
</div>

<div id="appScreen">
  <header><span>SAMTV</span><button onclick="logout()" style="width:auto; padding:5px 15px">خروج</button></header>
  <video id="player" controls autoplay playsinline></video>
  <div class="scroll-area">
    <div class="row-title">القنوات المباشرة</div><div class="row" id="live"></div>
    <div class="row-title">الأفلام</div><div class="row" id="movies"></div>
    <div class="row-title">المسلسلات</div><div class="row" id="series"></div>
  </div>
</div>

<script>
const API = "https://samtv4norm.d1d2.org/V7APK/login.php";
const KEY = "dFU9bkEXX65K2C";
const PROXY = "https://api.allorigins.win/raw?url=";

let all = { live:[], movies:[], series:[] };

function xorEncrypt(data) {
  let result = "";
  for (let i = 0; i < data.length; i++) {
    result += String.fromCharCode(data.charCodeAt(i) ^ KEY.charCodeAt(i % KEY.length));
  }
  return btoa(result);
}

async function activate(){
  const codeValue = document.getElementById("code").value.trim();
  const status = document.getElementById("status");
  if(!codeValue) return;

  // تثبيت هوية الجهاز في ذاكرة المتصفح
  let deviceID = localStorage.getItem("my_fixed_id");
  if(!deviceID) {
      deviceID = "SAM_WEB_" + Math.random().toString(36).substring(2, 10).toUpperCase();
      localStorage.setItem("my_fixed_id", deviceID);
  }

  status.style.color = "#0af";
  status.innerText = "جاري الربط بهوية الجهاز...";

  const loginData = JSON.stringify({ 
      code: codeValue, 
      action: "login", 
      device_id: deviceID,
      type: "iphone"
  });
  
  const encrypted = xorEncrypt(loginData);
  const finalUrl = PROXY + encodeURIComponent(API + "?json=" + encodeURIComponent(encrypted));

  try {
    const res = await fetch(finalUrl);
    const data = await res.json();

    if(data && (data.status === "success" || data.id)) {
       localStorage.setItem("ok","1");
       localStorage.setItem("user_code", codeValue);
       showApp();
    } else {
       status.style.color = "#ff3b30";
       status.innerText = data.msg || "الكود مقيد بجهاز آخر";
    }
  } catch(e){ status.innerText = "خطأ في الاتصال"; }
}

async function loadSection(action, rowId, storageKey) {
  const code = localStorage.getItem("user_code");
  const deviceID = localStorage.getItem("my_fixed_id");
  const payload = xorEncrypt(JSON.stringify({ code: code, action: action, device_id: deviceID }));
  
  try {
    const res = await fetch(PROXY + encodeURIComponent(API + "?json=" + encodeURIComponent(payload)));
    const data = await res.json();
    if(data && data.list) { render(rowId, data.list); }
  } catch(e){ console.log("Error loading section"); }
}

function render(id, list){
  document.getElementById(id).innerHTML = list.map(item => `
    <div class="card" onclick="play('${item.url}')">
      <img src="${item.logo || item.image || ''}" onerror="this.src='https://via.placeholder.com/120x160/222/fff?text=TV'">
      <p>${item.name}</p>
    </div>
  `).join('');
}

function play(url){
  const v = document.getElementById("player");
  if(Hls.isSupported()){ const h = new Hls(); h.loadSource(url); h.attachMedia(v); }
  else { v.src = url; }
}

function showApp(){
  document.getElementById("loginScreen").style.display="none";
  document.getElementById("appScreen").style.display="flex";
  loadSection("get_live","live","live");
  loadSection("get_movies","movies","movies");
  loadSection("get_series","series","series");
}

function logout(){ localStorage.clear(); location.reload(); }
if(localStorage.getItem("ok")==="1") showApp();
</script>
</body>
</html>
